<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Name -->
    <title>COMP 445 Lab 2 - Streaming App</title> 

    <!-- Link to main style sheet-->
    <link rel="stylesheet" href="style.css">

</head>

<body>

<script>
    const serverURL = 'team5@labs445-2.encs.concordia.ca';
    let video = document.getElementById('video_camera'); 
    let startbutton = document.getElementById('start_button');
    let stopbutton = document.getElementById('stop_button');
    //defining variables to store the recorded video and its data
    let recorder;
    let recordedChunks = [];

    //using Media Stream API 
    //requesting permission to use camera and mic; loalMediaStream is webcam
    function startup() {
        //video = document.getElementById('video_camera');
        //startbutton = document.getElementById('startbutton');
        navigator.mediaDevices.getUserMedia({video: { minWidth: 1280, minHeight: 720}, audio: false}) //false for dev, set back to true for assignment
            .then(function(stream) {
                let track = stream.getTracks()[0];
                video_camera.srcObject = stream;
            })
            .catch(function(error) {
                console.error("Error: could not access web cam or mic",error);
            });    
    }
    window.addEventListener("load", startup, false);


    //set up encoder
  const encoder = new VideoEncoder({
    //for dealing with encoded data
    output: handleChunk, 
    //for dealing with errors
    error: (e) => {
        console.log(e.message);
    },}
  );
    //parameters for output
    encoder.configure({ // need to change to 720p
        codec: "avc1",
        width: 640,
        height: 480,
        bitrate: 5_000_000, // 2 Mbps
        framerate: 30,
        }
    );

startbutton.addEventListener('click', function() {
    const trackProcessor = new MediaStreamTrackProcessor(track);
    const reader = trackProcessor.readable.getReader();
    while (true) {
        const result = await reader.read();
        if (result.done) break;
        const frameFromCamera = result.value;
    }
}
)


//function for dealing with chunks of encoded data
function handleChunk(chunk, metadata) {

}
//when the recorder is stopped, the recorded video is uploaded to the server
recorder.addEventListener('stop', function() {
    //creating a Blob from the recorded chunks
    const recordedBlob = new Blob(recordedChunks, { type: 'video/mp4' });
    
    //creating a FormData object to send the recorded video to the server
    const formData = new FormData();
    formData.append('video', recordedBlob, 'myvideo.mp4');
    
    //sending the FormData to the server using a fetch request
    fetch(serverURL, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        //updating the UI to show that the video has been uploaded
        startbutton.disabled = false;
        startbutton.textContent = 'Start Recording';
    })
    .catch(error => console.error(error));
});
</script> 

<div id = "title" class = "center">
    <h2>Comp 445 Lab2</h1>
    <h4>By: Kiana Greek - 40135171, Ryan Haniff - 27069421</h3>
</div>

<div id = "webcam" class = "center">
    <video id="video_camera" autoplay playsinline></video>
    <button class = "button" id="start_recording">Start Recording</button>
    <button class = "button" id="stop_recording">Stop Recording</button>
</div>


</body>

</html>