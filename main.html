<!DOCTYPE html>
<html>
  <head>
    <title>Webcam Recorder</title>
  </head>
  <body>
    <h1>Webcam Recorder</h1>
    <video id="video" width="640" height="480" autoplay></video>
    <button id="record-button">Record</button>
    <button id="stop-button" disabled>Stop</button>
    <script>
      const videoElement = document.getElementById("video");
      const recordButton = document.getElementById("record-button");
      const stopButton = document.getElementById("stop-button");
      let mediaRecorder;
      let chunks = [];

      navigator.mediaDevices.getUserMedia({ audio: true, video: true })
        .then(function (stream) {
          videoElement.srcObject = stream;
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = function (e) {
            chunks.push(e.data);
          };

          mediaRecorder.onstop = function () {
            const blob = new Blob(chunks, { type: "video/mp4" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "recording.mp4";
            document.body.appendChild(a);
            a.click();
            chunks = [];
          };
        })
        .catch(function (err) {
          console.log("Error: " + err);
        });

      recordButton.onclick = function () {
        mediaRecorder.start();
        recordButton.disabled = true;
        stopButton.disabled = false;
      };

      stopButton.onclick = function () {
        mediaRecorder.stop();
        recordButton.disabled = false;
        stopButton.disabled = true;
      };

      // Encoder I/O and file writing happens in a Worker to keep the UI
      // responsive.
      encodeWorker = new Worker('./encode-worker.js');

      // Tell the worker to start encoding the frames and writing the file.
      // NOTE: transferring frameStream and reading it in the worker is more
      // efficient than reading frameStream here and transferring VideoFrames
      // individually. This allows us to entirely avoid processing frames on the
      // main (UI) thread.
      encodeWorker.postMessage({
        type: 'start',
        fileHandle: handle,
        frameStream: frameStream,
        trackSettings: trackSettings
      }, [frameStream]);

    </script>
  </body>
</html>